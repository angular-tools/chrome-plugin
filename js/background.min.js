var Plugin=new function(){this.data={};this.getPopup=function(){var popups=chrome.extension.getViews({type:"popup"});return popups.length>0?popups[0].Popup:null};this.getPage=function(cb,injections){Plugin._sendMessageToPage({_msg:"getPage"},function(response){if(response===undefined){Plugin.injectFilesInPage([].concat("/src/bower_components/chrome-plugin/js/page.js","/src/js/page.js",injections||[]),function(response){Plugin.getPage(cb)})}else{if(typeof cb!=="undefined"){cb(response)}}})};this.getPageSelectedHTML=function(cb){Plugin.queryPage("getSelection",cb)};this.getPageHTML=function(cb){Plugin.queryPage("getHTML",cb)};this.getPageURL=function(cb){Plugin.queryPage("getURL",cb)};this.queryPage=function(msg,cb){Plugin.sendMessageToPage({_msg:msg},cb)};this.injectAllInPage=function(list,callback,tabId){var createCallback=function(tabId,injectDetails,innerCallback){return function(){if(/\.css/.test(injectDetails["file"])){chrome.tabs.insertCSS(tabId,injectDetails,innerCallback)}else{chrome.tabs.executeScript(tabId,injectDetails,function(result){if(chrome.runtime.lastError){}else{innerCallback(result)}})}}};for(var i=list.length-1;i>=0;--i){callback=createCallback(tabId,list[i],callback)}if(callback!==null){callback()}};this.injectFilesInPage=function(files,cb){var list=[];for(var i=0;i<files.length;i++){list.push({file:files[i]})}Plugin.injectAllInPage(list,cb)};this.injectFileInPage=function(src,cb){Plugin.injectFilesInPage([src])};this.injectCodeInPage=function(code,cb){Plugin.injectAllInPage([{code:code}],cb)};this.sendMessageToPage=function(msgObj,cb,config){Plugin.getPage(function(){Plugin._sendMessageToPage(msgObj,cb,config)})};this._sendMessageToPage=function(msgObj,cb,config){chrome.tabs.query(config||{windowId:chrome.windows.WINDOW_ID_CURRENT,active:true},function(tabs){for(var i=0;i<tabs.length;i++){(function(tab){chrome.tabs.sendMessage(tab,msgObj,function(response){if(typeof cb!=="undefined"){cb(response,tab)}})})(tabs[i].id)}})};this.get=function(key,cb,defaults,fresh){var setter=function(){Plugin.set(key,typeof defaults=="function"?defaults():defaults,cb)};if(fresh){setter()}else{chrome.storage.local.get(key,function(result){if(defaults&&(!result||typeof result[key]=="undefined")){setter()}else{cb(result[key])}})}};this.set=function(key,value,cb){var obj={};obj[key]=value;chrome.storage.local.set(obj,function(){cb(value)})};this.setData=function(key,value){Plugin.data[key]=value;if(typeof Plugin._refresh=="function"){Plugin._refresh()}};this._init=function(){if(typeof chrome!=="undefined"){if(chrome.browserAction){chrome.browserAction.onClicked.addListener(function(tab){if(typeof onPopup!=="undefined"){onPopup(tab)}})}if(chrome.runtime){chrome.runtime.onMessage.addListener(function(message,sender,sendResponse){if(message&&message._msg=="getPlugin"){sendResponse(Plugin)}else if(typeof onMessage!="undefined"){onMessage(message,sender,sendResponse)}})}}};this._init()};